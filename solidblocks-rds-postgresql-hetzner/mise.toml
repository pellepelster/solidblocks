[tasks.clean]
run = "rm -rf build"

[tasks.build]
run = """
#!/usr/bin/env bash
set -eu -o pipefail

if [[ -n "${CI:-}" ]]; then
  cp ${MISE_CONFIG_ROOT}/../solidblocks-cloud-init/blcks-cloud-init-bootstrap.sh "${MISE_CONFIG_ROOT}/modules/rds-postgresql/blcks-cloud-init-bootstrap.sh" ||  { echo "required artifacts not found, please build solidblocks-cloud-init first"; exit 1; }
else
  cp ${MISE_CONFIG_ROOT}/../solidblocks-cloud-init/build/blcks-cloud-init-bootstrap.sh "${MISE_CONFIG_ROOT}/modules/rds-postgresql/blcks-cloud-init-bootstrap.sh" ||  { echo "required artifacts not found, please build solidblocks-cloud-init first"; exit 1; }
fi


mkdir -p "${MISE_CONFIG_ROOT}/build/snippets"
(
    cd "${MISE_CONFIG_ROOT}/snippets"
    zip -r "${MISE_CONFIG_ROOT}/build/snippets/blcks-terraform-rds-postgresql-hetzner-snippet-s3-backup-v${VERSION}.zip" hetzner-postgres-rds-s3-backup/**/*.tf
    zip -r "${MISE_CONFIG_ROOT}/build/snippets/blcks-terraform-rds-postgresql-hetzner-snippet-local-backup-v${VERSION}.zip" hetzner-postgres-rds-s3-backup/**/*.tf
    zip -r "${MISE_CONFIG_ROOT}/build/snippets/blcks-terraform-rds-postgresql-hetzner-snippet-private-network-v${VERSION}.zip" hetzner-postgres-rds-private-network/**/*.tf
    zip -r "${MISE_CONFIG_ROOT}/build/snippets/blcks-terraform-rds-postgresql-hetzner-snippet-s3-backup-v${VERSION}.zip" hetzner-postgres-rds-hetzner-s3-backup/**/*.tf
)

terraform-docs markdown table "${MISE_CONFIG_ROOT}/modules/rds-postgresql" --hide modules --output-file "${MISE_CONFIG_ROOT}/modules/rds-postgresql/README.md"
terraform-docs markdown table "${MISE_CONFIG_ROOT}/modules/rds-postgresql" --hide modules --output-file "${MISE_CONFIG_ROOT}/../doc/content/hetzner/rds/_index.md"

(
  cd "${MISE_CONFIG_ROOT}/modules/rds-postgresql"
  zip -r "${MISE_CONFIG_ROOT}/build/blcks-terraform-rds-postgresql-hetzner-v${VERSION}.zip" *
)
"""


[tasks.test-restore-local-deploy]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_local_deploy
"""

[tasks.test-restore-local-run]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_local_run
"""

[tasks.test-restore-local-destroy]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_local_destroy
"""

[tasks.test-restore-local]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_local
"""

[tasks.test-restore-s3]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_s3
"""

[tasks.test-restore-gcp]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_restore_from_gcp
"""

[tasks.test-private-network]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_private_network
"""

[tasks.test-migration]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_migration
"""

[tasks.test-encryption]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_encryption
"""

[tasks.test-arm]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_arm
"""

[tasks.test-ssl]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_ssl
"""

[tasks.test-ssh]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_ssh
"""

[tasks.test-jumphost-ssh]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

source ${MISE_CONFIG_ROOT}/mise.sh
task_test_jumphost_ssh
"""

[tasks.release-prepare]
usage = """
arg "<version>"
"""
run = """
#!/usr/bin/env bash
set -eu -o pipefail
source ${ROOT_PROJECT}/lib/utils.sh

echo "setting version: ${usage_version}"
terraform_replace_module_version "snippets/hetzner-postgres-rds-local-backup/instance/main.tf" v${usage_version}
terraform_replace_module_version "snippets/hetzner-postgres-rds-private-network/instance/main.tf" v${usage_version}
terraform_replace_module_version "snippets/hetzner-postgres-rds-s3-backup/instance/main.tf" v${usage_version}
terraform_replace_module_version "snippets/hetzner-postgres-rds-hetzner-s3-backup/instance/main.tf" v${usage_version}
terraform_replace_variable_default 'solidblocks_rds_version' "modules/rds-postgresql/variables.tf" v${usage_version}
"""
