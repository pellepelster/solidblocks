+++
title = "Web S3 Docker"
description = "Static Webhosting, S3 and Docker repository for Hetzner"
overviewGroup = "hetzner"
faIcon = "fa-cloud"
+++

A Terraform module, creating a self-hosted static web hosting solution in the Hetzner cloud, offering S3 object storage
and a Docker registry.

* Public and private S3 buckets
* Custom domains for public S3 Buckets
* Public and private Docker Registry

# Prerequisites

The module will create DNS entries for the various service endpoints. This requires a valid DNS zone that is managed via
the [Hetzner Cloud API](https://www.hetzner.com/news/dns-beta/).

# Usage Example

```terraform
{{% include "/snippets/web-s3-docker-kitchen-sink/main.tf" %}}
```

# Configuration

## Name and DNS

The `name` and `dns_zone` will be used as base domain for all created endpoints using the pattern `<name>.<dns_zone>`.

## S3 Buckets

The variable `s3_buckets` can be used to auto-create S3 buckets during provisioning.

### Minimal Bucket configuration

```terraform
module "web_s3_docker" {
  # ...
  s3_buckets = [{ name = "bucket1" }]
}
```

will create a single S3 bucket named `bucket1` with autogenerated access keys for the bucket `owner`, a read-write `rw`
as well as a read-only `ro` user. The keys can be retrieved using the module output `s3_buckets`.

#### Example output for `s3_buckets`

```json
[
  {
    "name": "bucket1",
    "owner_key_id": "GKxxxxxxxxxxxxxxxxxxxxxxxx",
    "owner_secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "ro_key_id": "GKxxxxxxxxxxxxxxxxxxxxxxxx",
    "ro_secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "rw_key_id": "GKxxxxxxxxxxxxxxxxxxxxxxxx",
    "rw_secret_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    //...
  }
]
```    

Together with the base S3 api address from the output `s3_host` the bucket can be used with S3 tools like `s3cmd` like
this

```shell
export S3_HOST=$(terraform output -raw s3_host)
export ACCESS_KEY=$(terraform output -raw s3_host | jq '.[0].owner_key_id')
export SECRET_KEY=$(terraform output -raw s3_host | jq '.[0].owner_secret_key')

s3cmd --host-bucket ${S3_HOST} --host ${S3_HOST} --access_key ${ACCESS_KEY} --secret_key ${SECRET_KEY} ls s3://bucket1
```

### Custom access keys

You can override the access key ids as well as the secrets by providing your own. To do this simply provide them in the
bucket config

```terraform
module "web_s3_docker" {
  //...
  s3_buckets = [
    {
      name             = "bucket2",
      owner_key_id     = "cbeebb7f1fa4de50025a5c95",
      owner_secret_key = "f775d527e821ab035b5a874e6326f20c135b2d2fc903112fe768a17681f54043"
    },
  ]
}
```

`[owner|rw|ro]_key_id` has to be 24 characters long, and `[owner|rw|ro]_secret_key` 64. You can either provide both,
just one or none, the missing parts will be automatically generated. The module takes care to add the `GK` prefix which
is needed by the underlying S3 server.

### Static web hosting

By setting the bucket configuration `web_access_public_enable` to `true`, static web hosting can be enabled for the
Bucket, making all its content available on the internet. The list `web_access_domains` enables access to this bucket
using custom domains.

{{% notice tip %}}
DNS entries for all domains that are within the `dns_zone` are auto-created. If the provided `web_access_domains` is not
part of the `dns_zone` the `A` respectively `AAAA`  DNS entries need to be created manually, the IPv4 and IPv6 addresses
are available through the module output `ipv4_address` and `ipv6_address`.
{{% /notice %}}

The created web endpoints again can be retrieved via the `s3_buckets` output.

#### Example output for a bucket with `web_access_public_enable`

```json
[
  {
    "name": "bucket1",
    //...
    "web_access_public_enable": true,
    "web_access_addresses": [
      "https://bucket1.s3-web.web-s3-docker.blcks-test.de",
      "https://blcks-test.de",
      "https://www.blcks-test.de"
    ]
  }
]
```    


{{% notice tip %}}
When uploading content to be served it is important to use the correct mime-types, when using  s3cmd to upload content this can be achieved like this


`s3cmd sync --no-mime-magic --guess-mime-type ./contnt/* s3://<bucket_name>`

{{% /notice %}}



## Docker

By setting `docker_enable` to `true` the service will also expose a docker registry. The creation of credentials follows
the pattern of the S3 bucket access key creation. If no user is specified a read-write as well as a read-only user will
be autogenerated. Those can be retrieved via the outputs `docker_rw_users` respectively `docker_ro_users`.

### Example output for `docker_rw_users`

```json
[
  {
    "username": "61008df60fd0abac80a5cba645056a80",
    "password": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }
]
```    

using the private docker endpoint that can be retrieved from `docker_host_private`, docker images can be pushed like
this

```shell
export DOCKER_HOST_PRIVATE=$(terraform output -raw docker_host_private)
export DOCKER_USERNAME=$(terraform output -raw docker_rw_users | jq '.[0].username')
export DOCKER_PASSWORD=$(terraform output -raw docker_rw_users | jq '.[0].password')

echo ${DOCKER_PASSWORD} | docker login ${DOCKER_HOST_PRIVATE} --username ${DOCKER_USERNAME} --password-stdin
docker push ${DOCKER_HOST_PRIVATE}/my-image:latest
```

### Public registry

When `docker_public_enable` is set to `true` all images that are pushed to the private endpoint (`docker_host_private`)
cn be pulled without authentication from the public endpoint

```shell
export DOCKER_HOST_PUBLIC=$(terraform output -raw docker_host_public)

docker pull ${DOCKER_HOST_PUBLIC}/my-image:latest
```

## Endpoints

| endpoint                | description                                                                                                                                                                                                                                        | address                                               |
|-------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|
| S3                      | S3 api endpoint                                                                                                                                                                                                                                    | &lt;bucket&gt;.s3.&lt;name&gt;.&lt;dns_zone&gt;       |
| S3 Web                  | public accessible endpoint if `web_access_public_enable` is set to `true`                                                                                                                                                                          | &lt;bucket&gt;.s3-web.&lt;name&gt;.&lt;dns_zone&gt;   |
| S3 Admin API            | API endpoint for the [GarageFS S3 admin API](https://garagehq.deuxfleurs.fr/documentation/reference-manual/admin-api/). Adress can be as well as the access token can be retrieved from the output `garage_admin_address` and `garage_admin_token` | s3-admin.&lt;name&gt;.&lt;dns_zone&gt; |
| private docker registry | endpoint for publishing and pulling Docker images usein credentials                                                                                                                                                                                | docker-private.s3-web.&lt;name&gt;.&lt;dns_zone&gt;   |
| public docker registry  | endpoint unauthorized pulling if enabled via `docker_public_enable`                                                                                                                                                                                | docker-public.s3-web.&lt;name&gt;.&lt;dns_zone&gt;    |

# Terraform Module

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_hcloud"></a> [hcloud](#requirement\_hcloud) | >=1.56.0 |
| <a name="requirement_http"></a> [http](#requirement\_http) | >= 3.3.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_hcloud"></a> [hcloud](#provider\_hcloud) | >=1.56.0 |
| <a name="provider_random"></a> [random](#provider\_random) | n/a |

## Resources

| Name | Type |
|------|------|
| [hcloud_primary_ip.ipv4](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/primary_ip) | resource |
| [hcloud_primary_ip.ipv6](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/primary_ip) | resource |
| [hcloud_server.server](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/server) | resource |
| [hcloud_volume.data](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/volume) | resource |
| [hcloud_volume_attachment.data](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/volume_attachment) | resource |
| [hcloud_zone_rrset.root_domain_catchall_ipv4](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/zone_rrset) | resource |
| [hcloud_zone_rrset.root_domain_ipv4](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/zone_rrset) | resource |
| [hcloud_zone_rrset.web_access_domains_ipv4](https://registry.terraform.io/providers/hetznercloud/hcloud/latest/docs/resources/zone_rrset) | resource |
| [random_bytes.admin_token](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_ro_default_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_ro_default_user](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_ro_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_rw_default_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_rw_default_user](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.docker_rw_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.metrics_token](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.owner_key_ids](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.owner_secret_keys](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.ro_key_ids](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.ro_secret_keys](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.rpc_secret](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.rw_key_ids](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |
| [random_bytes.rw_secret_keys](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/bytes) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_data_volume_size"></a> [data\_volume\_size](#input\_data\_volume\_size) | data volume size in GB | `number` | `64` | no |
| <a name="input_datacenter"></a> [datacenter](#input\_datacenter) | n/a | `string` | `"nbg1-dc3"` | no |
| <a name="input_dns_zone"></a> [dns\_zone](#input\_dns\_zone) | DNS zone to use for hostname and DNs entries | `string` | n/a | yes |
| <a name="input_docker_enable"></a> [docker\_enable](#input\_docker\_enable) | Enable Docker registry | `bool` | `false` | no |
| <a name="input_docker_public_enable"></a> [docker\_public\_enable](#input\_docker\_public\_enable) | Enable public anonymous access to Docker registry, see https://pellepelster.github.io/solidblocks/hetzner/web-s3-docker/#docker for details | `bool` | `false` | no |
| <a name="input_docker_ro_users"></a> [docker\_ro\_users](#input\_docker\_ro\_users) | Docker read-write users to provision. If no users is given a user will be auto.created, see https://pellepelster.github.io/solidblocks/hetzner/web-s3-docker/#docker for details | <pre>list(object({<br/>    username : string,<br/>    password : optional(string)<br/>  }))</pre> | `[]` | no |
| <a name="input_docker_rw_users"></a> [docker\_rw\_users](#input\_docker\_rw\_users) | Docker read-write users to provision. If no users is given a user will be auto.created, see https://pellepelster.github.io/solidblocks/hetzner/web-s3-docker/#docker for details | <pre>list(object({<br/>    username : string,<br/>    password : optional(string)<br/>  }))</pre> | `[]` | no |
| <a name="input_labels"></a> [labels](#input\_labels) | A list of labels to be attached to the server instance. | `map(any)` | `{}` | no |
| <a name="input_location"></a> [location](#input\_location) | Hetzner location to use for provisioned resources | `string` | `"nbg1"` | no |
| <a name="input_name"></a> [name](#input\_name) | Unique name for the server instance | `string` | n/a | yes |
| <a name="input_s3_buckets"></a> [s3\_buckets](#input\_s3\_buckets) | S3 buckets to provision, see https://pellepelster.github.io/solidblocks/hetzner/web-s3-docker/#s3-buckets for details | <pre>list(object({<br/>    name                     = string<br/>    owner_key_id             = optional(string)<br/>    owner_secret_key         = optional(string)<br/>    ro_key_id                = optional(string)<br/>    ro_secret_key            = optional(string)<br/>    rw_key_id                = optional(string)<br/>    rw_secret_key            = optional(string)<br/>    web_access_public_enable = optional(bool, false)<br/>    web_access_domains       = optional(list(string))<br/>  }))</pre> | `[]` | no |
| <a name="input_server_type"></a> [server\_type](#input\_server\_type) | Hetzner cloud server type, supports x86 and ARM architectures | `string` | `"cx23"` | no |
| <a name="input_ssh_keys"></a> [ssh\_keys](#input\_ssh\_keys) | ssh keys to provision for instance access | `list(number)` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_docker_host_private"></a> [docker\_host\_private](#output\_docker\_host\_private) | fully qualified domain for the private docker registry |
| <a name="output_docker_host_public"></a> [docker\_host\_public](#output\_docker\_host\_public) | fully qualified domain for the public docker registry if enabled |
| <a name="output_docker_ro_users"></a> [docker\_ro\_users](#output\_docker\_ro\_users) | readonly users for the docker registry |
| <a name="output_docker_rw_users"></a> [docker\_rw\_users](#output\_docker\_rw\_users) | write users for the docker registry |
| <a name="output_garage_admin_address"></a> [garage\_admin\_address](#output\_garage\_admin\_address) | address for the GarageFS admin endpoint |
| <a name="output_garage_admin_token"></a> [garage\_admin\_token](#output\_garage\_admin\_token) | token for the GarageFS admin endpoint |
| <a name="output_ipv4_address"></a> [ipv4\_address](#output\_ipv4\_address) | IPv4 address of the created server |
| <a name="output_ipv6_address"></a> [ipv6\_address](#output\_ipv6\_address) | IPv6 address of the created server |
| <a name="output_s3_buckets"></a> [s3\_buckets](#output\_s3\_buckets) | the created S3 bucket with access credentials and public endpoints if available |
| <a name="output_s3_host"></a> [s3\_host](#output\_s3\_host) | fully qualified for the s3 endpoint |
| <a name="output_server_id"></a> [server\_id](#output\_server\_id) | Hetzner ID of the created server |
<!-- END_TF_DOCS -->
