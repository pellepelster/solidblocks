#!/usr/bin/env bash

set -eu

DIR="$(cd "$(dirname "$0")" ; pwd -P)"

source "${DIR}/../solidblocks-shell/lib/log.sh"
source "${DIR}/../solidblocks-shell/lib/python.sh"
source "${DIR}/../lib/terraform.sh"
source "${DIR}/../lib/utils.sh"

export VERSION="$(version)"

function task_build {
  ${DIR}/../gradlew :solidblocks-cloud-init:assemble
}

function task_lint {
  ensure_environment
  find "${DIR}/lib" -name "*.sh" -exec shellcheck {} \;
}

function task_test {
  if [[ "${SKIP_TESTS:-}" =~ .*integration.* ]]; then
    exit 0
  fi

  local tests="${1:-$TESTS}"
  for test in ${tests}; do
    run_test "${test}"
  done
}

function task_release_test {
  curl -L "https://github.com/pellepelster/solidblocks/releases/download/${VERSION}/blcks-cloud-init-bootstrap-${VERSION}.sh" -o "/tmp/blcks-cloud-init-bootstrap-${VERSION}.sh"
  chmod +x "/tmp/blcks-cloud-init-bootstrap-${VERSION}.sh"
  docker run -ti -v "/tmp/blcks-cloud-init-bootstrap-${VERSION}.sh:/blcks-cloud-init-bootstrap.sh" debian:bookworm /bin/bash -c /blcks-cloud-init-bootstrap.sh
}

function task_test_ssh {
    local test=${1}
    shift || true
    ssh -F "${DIR}/test/${test}/ssh_config" "test" ${@}
}

function task_clean {
  rm -rf "${DIR}/build"
}

function task_usage {
  echo "Usage: $0 ..."
  exit 1
}

arg=${1:-}
shift || true
case ${arg} in
  lint) task_lint "$@" ;;
  clean) task_clean "$@" ;;
  build) task_build "$@" ;;
  test) task_test "$@" ;;
  format) ;;
  release-artifacts) ;;
  test-ssh) task_test_ssh "$@" ;;
  release-prepare) ;;
  release-test) task_release_test "$@" ;;
  *) task_usage ;;
esac
