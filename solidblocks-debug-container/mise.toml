[env]
DOCKER_IMAGE_NAME="solidblocks-debug-container"
DOCKER_OPTIONS="--push"

[tasks.build]
run = """
#!/usr/bin/env bash
set -eu -o pipefail

${ROOT_PROJECT}/gradlew :$(basename $PWD):assemble

docker buildx build \
  --build-arg VERSION=${VERSION} \
  --platform linux/amd64 \
  ${DOCKER_OPTIONS} \
  --tag "${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${VERSION}-snapshot" \
  --tag "${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:snapshot" \
  .
"""

[tasks.test]
run = """
#!/usr/bin/env bash
set -eu -o pipefail

# TODO fix tests
exit 0

${ROOT_PROJECT}/gradlew :$(basename $PWD):test --stacktrace
"""

[tasks.clean]
run = "rm -rf build"

[tasks.format]
run = "${ROOT_PROJECT}/gradlew :$(basename $PWD):spotlessApply"

[tasks.release-artifacts]
run="""
#!/usr/bin/env bash
set -eu -o pipefail

docker buildx imagetools create -t "${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${VERSION}" "${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${VERSION}-snapshot"
"""

[tasks.release-test]
usage = """
arg "<version>"
"""
run = """
#!/usr/bin/env bash
set -eu -o pipefail

docker pull "${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/${DOCKER_IMAGE_NAME}:${usage_version}"
"""

[tasks.preflight-check]
run = [
    { task = "clean" },
    { task = "format" },
    { task = "build" },
    { task = "test" },
]
